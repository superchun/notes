# JS 中的 closure 和 scopes

## Closure

## Scopes

JS 中代码的执行分为两阶段：第一阶段在创建新的词法环境（lexical environment）的时候被激活，在这个阶段，代码不会执行，但是 JS 引擎会在当前词法环境中访问会注册所有已声明的变量和方法；第二阶段在第一阶段完成之后开始，在这个阶段 JS 代码开始执行，实际的行为取决于变量的类型（let, var, const, 函数声明）和环境的类型（global, function, block）。

整个过程如下：

1. 如果创建了一个 function 环境，那么隐式的 arguments 标识符会被创建，连同所有的形参和它们的实参的值。如果实在非 function 环境下，这步会被跳过。
2. 如果创建了一个 global 或 function 环境，那么当前的代码会被扫描，以查找函数声明（不包括函数表达式和箭头函数）。每当发现一个函数声明，一个新的函数会被创建，并将其绑定到当前环境中带有该函数名称的标识符。如果标识符名称已经存在，那么它的值会被覆写。如果是在 block 环境，这步会被跳过。
3. 扫描当前代码以获取变量声明。在 function 和 global 环境中，所有通过 var 关键字声明和定义在其它函数外的变量会被找到，所有通过 let 和 const 关键字声明和定义在其它函数和块之外的变量会被找到。在 block 环境中，只在当前 block 中扫描查找以 let 和 const 声明的变量。每当发现一个变量，如果在环境中不存在它的标识符，那么该标识符会被注册并初始化为 undefined，如果标识符存在，那么会保留它的值。



